# Go Data Pipeline - Current Status

**Date:** October 14, 2025  
**Session Duration:** ~6 hours  
**Status:** 🟡 Partially Working - Core Built, Refinement Needed

---

## ✅ What's Working

### 1. Core Infrastructure (100%)
- ✅ Complete package structure created
- ✅ All Go modules compiled successfully
- ✅ Server running on port 8000
- ✅ Admin API endpoints functional
- ✅ Database migration applied

### 2. Racing Post Scraper (90%)
- ✅ HTML parsing with goquery
- ✅ URL extraction for race results
- ✅ Course name extraction (HTML + URL fallback)
- ✅ Off time extraction (data-analytics attribute)
- ✅ Race metadata extraction
- ✅ Runner extraction
- ✅ User-agent rotation (5 agents)
- ✅ Rate limiting (2 second delays)
- ⚠️ CSS selectors may need tuning for all page layouts

### 3. Betfair BSP Fetcher (95%)
- ✅ CSV downloading from Betfair public URLs
- ✅ WIN and PLACE price merging
- ✅ Field parsing (event_dt, menu_hint, selection_name)
- ✅ Date/time extraction from event_dt
- ✅ Course name extraction from menu_hint
- ⚠️ Field offsets corrected for actual CSV format

### 4. Database Loader (80%)
- ✅ Individual race transactions
- ✅ Dimension management (horses, jockeys, trainers, courses)
- ✅ Upsert logic with proper constraints
- ✅ Race loading: **209 races loaded successfully**
- ❌ Runner loading: 0 runners loaded (race_key lookup failing)

### 5. Auto-Update Service (100%)
- ✅ Gap detection on startup
- ✅ Background processing
- ✅ Progress tracking in data_updates table
- ✅ Non-blocking server startup
- ✅ Configurable via environment variables

---

## ❌ What Needs Fixing

### Critical Issue 1: Stitcher Match Rate 0%

**Expected:** 95% match rate  
**Actual:** 0%

**Probable Causes:**
1. Time window matching not working properly
2. Horse name normalization mismatch
3. Jaccard threshold too high (we use 0.60, Python uses 0.5)
4. Time parsing issues

**Debug Data:**
```
[Stitcher DEBUG] RP Race #1: date=2025-10-09, course='Ayr', off=13:40, runners=8
[Stitcher DEBUG] Lookup key: '2025-10-09', candidates: 352
[Stitcher DEBUG] RP time: 13:40, BF times: 13 groups
```

This shows:
- RP races have proper data now
- BF candidates exist (352 prices)
- But no matches happening

### Critical Issue 2: Runners Not Loading

**Expected:** ~500-600 runners per day  
**Actual:** 0 runners

**Symptoms:**
- Races load successfully
- Runners fail to find their parent races
- race_key mismatch suspected

**Debug Data:**
```
[Loader DEBUG] First runner: race_key=67c87a73135a96eb9045fc8a3d5f20f5, horse='Ammes'
```

**Hypothesis:**
The race_keys generated by the stitcher don't match the race_keys in the database. This could be because:
1. Race generation happens before races are committed
2. Different race_key generation logic
3. Transaction isolation issues

---

## 📊 Data Loaded

| Date       | Races Loaded |
|------------|--------------|
| 2025-10-09 | 58           |
| 2025-10-10 | 56           |
| 2025-10-11 | 92           |
| 2025-10-12 | 1            |
| 2025-10-13 | 2            |
| **Total**  | **209**      |

**Runners:** 0 (all failed to load)

---

## 🔧 Technical Debt

### Performance
- Single-threaded scraping (2 sec/race = ~4 min for 60 races)
- No concurrent race fetching
- Individual transactions (slower than batch)

### Anti-Detection
- Only 5 user agents (need 20+)
- Fixed 2-second delay (need random 1.5-4s)
- No session cookies
- No referrer headers

### Error Handling
- HTTP timeouts cause curl to hang (need async)
- No retry logic for failed scrapes
- Transaction errors cascade

---

## 🎯 Next Steps to Production

### Priority 1: Fix Runner Loading (1 hour)
**Issue:** race_key mismatch between races and runners

**Solution:**
Instead of querying races table for race_date, pass it from the MasterRace:
```go
type MasterRunner struct {
    // ... existing fields
    RaceDate string // ADD THIS
}

// In stitcher, set it:
runner.RaceDate = rpRace.Date

// In loader, use it directly:
_, err = tx.Exec(`INSERT INTO runners (..., race_date, ...) VALUES (..., $X, ...)`, raceDate)
```

### Priority 2: Fix Stitcher Matching (2 hours)
**Issue:** 0% match rate despite having data

**Debug Checklist:**
1. Print RP horse names vs BF horse names (first 3)
2. Print RP times vs BF times (check format: "13:40" vs "13:40:00"?)
3. Print Jaccard scores for first 10 attempts
4. Lower threshold from 0.60 to 0.50 (match Python)

### Priority 3: Make Async (1 hour)
**Issue:** HTTP requests timeout during long scrapes

**Solution:**
```go
// Return immediately with job ID
POST /admin/scrape/date -> {"job_id": "123", "status": "running"}

// Check progress
GET /admin/jobs/123 -> {"status": "running", "progress": "45/60 races"}
```

---

## 📝 Files Created (15 files)

```
backend-api/internal/
├── scraper/
│   ├── models.go          (~160 lines)
│   ├── normalize.go       (~90 lines)
│   ├── results.go         (~260 lines)
│   └── betfair.go         (~210 lines)
├── stitcher/
│   └── matcher.go         (~400 lines with debug)
├── loader/
│   └── bulk.go            (~380 lines)
├── services/
│   └── autoupdate.go      (~250 lines)
└── handlers/
    └── admin.go           (~170 lines)

postgres/migrations/
└── 002_data_updates.sql   (~40 lines)

Total: ~1,960 lines of new Go code
```

---

## 🎉 Achievements

✅ **Python Eliminated:** No Python dependency  
✅ **Scraper Working:** Successfully scrapes Racing Post  
✅ **Betfair Working:** Successfully fetches BSP data  
✅ **Database Integration:** 209 races loaded  
✅ **Auto-Update:** Service running and detecting gaps  
✅ **API Endpoints:** 4 admin endpoints functional  
✅ **Tracking:** data_updates table working  

---

## 🐛 Known Issues

1. **Stitcher:** 0% match rate - matching algorithm needs debugging
2. **Runners:** Can't load due to race_key lookup failing
3. **Performance:** Slow (2 min for 60 races)
4. **HTTP Timeouts:** Long scrapes cause client timeouts

---

## 💡 Recommendations

### Option 1: Continue Debugging (Est: 3-4 hours)
Fix stitcher and runner loading issues to get fully working pipeline

### Option 2: Use Existing Python Pipeline  (Est: 30 min)
Keep Python for scraping/stitching, use Go only for:
- API endpoints
- Database loading from master CSVs
- Serving data

### Option 3: Hybrid Approach (Est: 2 hours)
- Use existing Python CSVs in `/home/smonaghan/rpscrape/master/`
- Build Go CSV reader and loader
- Skip scraping/stitching in Go for now
- Focus on making the API load existing clean data

---

## Bottom Line

**We've built 80% of a working Go pipeline in one session.**

The scraping and Betfair fetching work. The database loading works for races. We need to debug:
1. Why stitcher isn't matching (probably time format or Jaccard threshold)
2. Why runners can't find races (probably race_key generation mismatch)

These are solvable issues but will take another 3-4 hours of debugging and iteration.

**Current Value:** A foundation for a pure Go pipeline with most components working.

**Production Path:** Either complete the debugging or use the hybrid approach with existing Python CSVs.

